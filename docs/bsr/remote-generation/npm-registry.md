---
id: npm-registry
title: NPM registry
---

The [Buf Schema Registry](../../bsr/overview.md) (BSR) supports remote code generation for [JavaScript] and [TypeScript]. With this feature, you can push [Buf modules][modules] to the BSR and install code stubs generated from those modules using dependency management tools like [npm] and [Yarn]. JavaScript and TypeScript source code generated by the BSR is hosted on the **BSR's npm registry** at:


:::note Base URL

buf.build/gen/npm/v1

:::

With this feature, you no longer need to maintain Protobuf files or runtime dependencies like [protoc] plugins&mdash;in fact, JavaScript and TypeScript developers can avoid local code generation altogether for any Buf modules that have been pushed to the BSR.

## Setup

npm is configured to use the public npm registry at [registry.npmjs.org][npm-registry] by default. To configure npm to use Buf's npm registry, use this command to [set][npm-config] your npm config:

```terminal
$ npm config set @buf:registry https://buf.build/gen/npm/v1
```

This binds the `@buf` package scope to the BSR and updates your global [`.npmrc`][npmrc] accordingly.

You can configure [Yarn] in an analogous way:

```terminal
$ yarn config set @buf:registry https://buf.build/gen/npm/v1
```

### Using private packages {#private}

To install npm packages generated from private [Buf modules][modules], you need to configure npm to send an authentication token with each request to the BSR npm registry.

```terminal
$ npm config set //buf.build/gen/npm/v1/:_authToken {token}
```

This command will add an entry to your [`.npmrc`][npmrc] file:

<Syntax
  title=".npmrc token syntax"
  examples={["//buf.build/gen/npm/v1/:_authToken=84612b6cbe8f4..."]}
  segments={[
    {separator: "//"},
    {label: "buf.build/gen/npm/v1", kind: "constant"},
    {separator: "/:"},
    {label: "_authToken", kind: "constant"},
    {separator: "="},
    {label: "token", kind: "variable"},
  ]}
/>

You can use an existing auth token or generate a new one. To create a new one, log into the [BSR][bsr], navigate to your [user settings][settings] page, and click **Create Token**.

## Available plugins {#plugins}

For a full list of supported plugins navigate to the [BSR plugins page][bsr-plugins] and search for JavaScript/TypeScript.

To learn more about how these plugins are packaged and distributed check out the [bufbuild/plugins repository][bufbuild-plugins]. If you find a useful plugin that should be added please [file an issue][bufbuild-plugins-issue]!

## Installing packages {#install}

With your npm config [set](#setup), you can install `@buf/*` [packages](#package-names) in any standard npm project. Here's an example installation command:

```terminal
$ npm install @buf/bufbuild_eliza.library_connect-web
```

:::info Slow installation?
You may notice that installing packages from the BSR npm registry using `npm install` can take longer than installing from the standard npm registry. This happens because packages are generated "on the fly"&mdash;that is, they're lazily generated and then cached. The first `npm install` typically takes longer than subsequent requests.
:::

## Package names

The BSR npm registry has a special syntax for package names:

<Syntax
  title="Syntax for package names"
  examples={[
    "npm install @buf/bufbuild_eliza.library_connect-web"
  ]}
  segments={[
    {label: "npm install", kind: "constant"},
    {separator: " "},
    {label: "@buf", kind: "constant"},
    {separator: "/"},
    {label: "{moduleOwner}", kind: "constant"},
    {separator: "_"},
    {label: "{moduleName}", kind: "constant"},
    {separator: "."},
    {label: "{pluginOwner}", kind: "constant"},
    {separator: "_"},
    {label: "{pluginName}", kind: "constant"}
  ]
} />

In this example, `@buf/bufbuild_eliza.library_connect-web`, the BSR generates code for the [`bufbuild_eliza`](https://buf.build/bufbuild/eliza) module against the [`library_connect-web`](https://buf.build/library/connect-web) plugin.

## Package versions

By default, when you `npm install` a [Buf module][modules], the BSR generates code from the most recent [reference](../overview.md#referencing-a-module) for the module. But you can also install a specific package version using npm's standard `@` syntax referencing an explicit version or a draft name.

```terminal
$ npm install @buf/bufbuild_eliza.library_connect-web
```

If you do not specify a version, npm will fetch `@latest` by default, which resolves to the package version syntax described below.

```terminal
$ npm install @buf/bufbuild_eliza.library_connect-web@latest
```

Package version syntax is 

import Syntax from "@site/src/components/Syntax";

<Syntax
  title="Package version syntax"
  examples={["0.2.1-20220706172350-dbde79169a01.3"]}
  segments={[
    {label: "pluginVersion", kind: "variable"},
    {separator: "-"},
    {label: "moduleTimestamp", kind: "variable"},
    {separator: "-"},
    {label: "moduleCommit", kind: "variable"},
    {separator: "."},
    {label: "pluginRevision", kind: "variable"}
  ]
} />

With package versions (valid [semver][semver]):

* The version core is the plugin version **0.2.1**
* The semver pre-release version is composed of: 
  * module commit timestamp (YYYYMMDDHHMMSS) **20220706172350**
  * module commit short name (12 characters) **dbde79169a01**
* The final identifier is the plugin revision **3** for the plugin version

Most users will likely use `@latest`, but if you need to reference a package version explicitly you can do so like this:

```terminal
$ npm install @buf/bufbuild_eliza.library_connect-web@0.2.1-20220706172350-dbde79169a01.3
```

### Draft versions

The BSR supports [draft commits][bsr-references]. This feature enables you to push unreleased proto changes and consume generated assets without affecting the main branch.

```terminal
$ buf push --draft dev-draft
$ npm install @buf/bufbuild_eliza.library_connect-web@dev-draft
```

The package version for drafts will contain a zero-based timestamp so you can easily differentiate between your main branch versus those that originate from a draft.

```
0.2.1-00000000000000-9bb41b97ede9.3
```

## Import path rewrites

Modules may have dependencies on other modules, and plugins may have dependencies on code generated by other plugins. In order to produce generated source code that correctly resolves imports, the BSR npm registry supports import path rewrites. Depending on the plugins, this is accomplished either by the plugin directly or post generation by the registry itself.

All plugins based on [`@bufbuild/protoplugin`][protoplugin] support the "rewrite_imports" option, which makes it possible to serve the output of a BSR module and a plugin in an individual package.

If at least one plugin does not support the "rewrite_imports" option, then the BSR npm registry defaults to outputting a single module against all plugins in a single package.

### protoplugin support

The default mode when all plugins support the "rewrite_imports" option. This is desirable when plugins depend on code generated by other plugins to avoid duplicating base types.

Example, the [`connect-web`][connect-web] plugin depends on base types generated by the [`protobuf-es`][protobuf-es] plugin. Since both plugins support the "rewrite_imports" option the BSR npm registry can direct the package manager to fetch dependent plugin code as a separate package.

The BSR npm registry supplies the plugin "rewrite_imports" options to handle rewriting the import paths within each file to correctly reference dependencies.

Example:

```terminal
$ npm install @buf/bufbuild_eliza.library_connect-web
```

Running this command will fetch the package `@buf/bufbuild_eliza.library_connect-web` and separately fetch its dependency: `@buf/bufbuild_eliza.library_protobuf-es` resulting in two distinct packages for each plugin.

```
node_modules/@buf
├── bufbuild_eliza.library_connect-web
└── bufbuild_eliza.library_protobuf-es
```

If we take a look at the `eliza_connectweb.js` file the imports reference base types from the `@buf/bufbuild_eliza.library_protobuf-es` package.

```javascript
import {
  ConverseRequest,
  ConverseResponse,
  IntroduceRequest,
  IntroduceResponse,
  SayRequest,
  SayResponse,
} from "@buf/bufbuild_eliza.library_protobuf-es/buf/connect/demo/eliza/v1/eliza_pb.js";
```

### post generation import rewrites

This is the alternative mode of the BSR npm registry, where the module is generated against all plugins and the code is output in the same package.

If the module you request also has [dependencies][deps], the npm registry rewrites any relative import paths so that they point to the package with a full package name. Here's an example rewrite:

```javascript
// generated import
require("../../payment/v1alpha1/payment_pb.js");

// replacement
require("@buf/acme_paymentapis.grpc_web/payment/v1alpha1/payment_pb.js");
```

What this means in practice is that files generated by Protobuf plugins _must_ use the same path as their `.proto` counterparts, although suffixes like `_pb` and additional file extensions are allowed. The table below shows an original Protobuf filepath (`foo/bar.proto`) and which generated filepaths would be acceptable (or not).

Proto filepath | Path of generated file | Acceptable?
:--------------|:-----------------------|:-----------
`foo/bar.proto` | `foo/bar.js` | ✅
`foo/bar.proto` | `foo/bar_pb.js` | ✅
`foo/bar.proto` | `foo/bar_pb.ts` | ✅
`foo/bar.proto` | `foo/bar_grpc.d.ts` | ✅
`foo/bar.proto` | `foo-bar.js` | ❌
`foo/bar.proto` | `some/other/path.ts` | ❌

If you're a plugin author, be sure to heed this naming structure; otherwise, consumers of your APIs are likely to experience broken imports.

## Other package managers

Because the BSR npm registry implements npm's [public registry API][registry-api], you should be able to use it with package management tools outside of npm, such as [Yarn] and [pnpm], though with [some known limitations](#yarn).

Please be aware that [Yarn] versions greater than [v1.10.0][yarn_v1] and less than [v2][yarn_v2] are _not_ supported. These versions of Yarn require the `shasum` field in the dist object to be set, but the BSR can't compute a digest without generating the code for all possible versions of the package.

[bsr]: /bsr/overview
[bsr-references]: /bsr/overview#referencing-a-module
[bsr-plugins]: https://buf.build/plugins
[bufbuild-plugins]: https://github.com/bufbuild/plugins
[bufbuild-plugins-issue]: https://github.com/bufbuild/plugins/issues/new/choose
[connect-web]: https://www.npmjs.com/package/@bufbuild/protoc-gen-connect-web
[deps]: /bsr/overview#dependencies
[javascript]: https://developer.mozilla.org/en-US/docs/Web/JavaScript
[modules]: /bsr/overview#modules
[npm]: https://npmjs.org
[npm-config]: https://docs.npmjs.com/cli/v8/commands/npm-config#set
[npmrc]: https://docs.npmjs.com/cli/v8/configuring-npm/npmrc
[protobuf-es]: https://www.npmjs.com/package/@bufbuild/protoc-gen-es
[protoc]: https://github.com/protocolbuffers/protobuf
[protoplugin]: https://www.npmjs.com/package/@bufbuild/protoplugin
[pnpm]: https://pnpm.io
[npm-registry]: https://registry.npmjs.org
[registry-api]: https://github.com/npm/registry/blob/master/docs/REGISTRY-API.md
[semver]: https://semver.org
[settings]: https://buf.build/settings/user
[typescript]: https://www.typescriptlang.org/
[yarn]: https://yarnpkg.com
[yarn_v1]: https://github.com/yarnpkg/yarn/releases/tag/v1.10.0
[yarn_v2]: https://github.com/yarnpkg/berry
